<!DOCTYPE html>
<html>
<head>
	<style>
	
	.header   {width: 512px;}
	.tinput {margin-right: 50px; text-align:right;  float:right;
}
</style>
</head>
<body>
<canvas id="myCanvas" width="1024" height="512"
style="border:1px solid #c3c3c3;">
Your browser does not support the canvas element.
</canvas>
<div >
	<p class="header">Luminance: <span id="text_luminance"></span>
		<span class="tinput"><input  type="range" id="range_luminance" value="50"/></span>
	 </p>
	 <p class="header">a-correction: <span id="txt_a_correction"></span>
		<span class="tinput"><input  type="range" id="a_correction" value="50"/></span>
	 </p>
	 <p class="header">b-correction: <span id="txt_b_correction"></span>
		<span class="tinput"><input  type="range" id="b_correction" value="50"/></span>
	 </p>
	 <p class="header">Saturation-correction: <span id="txt_sat_correction"></span>
		<span class="tinput"><input  type="range" id="sat_correction" value="50"/></span>
	 </p>
</div>
<div>
	<button type="button" id="lab_btn">LAB Palette</button>
	<button type="button" class="test_btn" img-data="Test.jpg">1</button>
	<button type="button" class="test_btn" img-data="Test0.png">2</button>
	<button type="button" class="test_btn" img-data="Test1.png">3</button>
	<button type="button" class="test_btn" img-data="Test2.png">4</button>
	<button type="button" class="test_btn" img-data="Test3.png">5</button>
	<button type="button" class="test_btn" img-data="Test4.png">6</button>
	<button type="button" class="test_btn" img-data="Test5.png">7</button>
	<button type="button" class="test_btn" img-data="Test6.png">8</button>
	<button type="button" class="test_btn" img-data="JTest2.jpg">9</button>
	<button type="button" class="test_btn" img-data="JTest3.jpg">10</button>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script>

function pow3(x) 
{
	return x * x * x;
}



function LUV2XYZ(clr, cn, vn) 
{
	var L = clr[0], u = clr[1], v = clr[2];
	var Yn = 1;
	var Un_prime = 0.2009 + cn;
	var Vn_prime = 0.4610 + vn;

	var u_prime	= u / (13 * L) + Un_prime;
	var v_prime	= v / (13 * L) + Vn_prime;
	var Y = pow3((L + 16.0) / 116.0);
    if (L < 8)
        Y = L / 903.3;
    // var Y = (luv(1,:) < 8.0) .* (Yn * luv(1,:) / 903.3) + (luv(1,:) >= 8.0) .* (Yn * (((luv(1,:) + 16.0) / 116.0) .^ 3));
	var X = 9 * u_prime * Y / (4 * v_prime);
	var Z = (12 - 3 * u_prime - 20 * v_prime) * Y / (4 * v_prime);
	X *= (0.950456 * 255);
    Y *=             255;
    Z *= (1.088754 * 255);
	return [X, Y, Z]
}

function LAB2XYZ(clr)
{
	var L = clr[0], a = clr[1], b = clr[2];
	var X, Y, Z, fX, fY, fZ;
    var RR, GG, BB;

    fY = pow3((L + 16.0) / 116.0);
    if (fY < 0.008856)
        fY = L / 903.3;
    Y = fY;

    if (fY > 0.008856)
        fY = Math.pow(fY, 1.0/3.0);
    else
        fY = 7.787 * fY + 16.0/116.0;

    fX = a / 500.0 + fY;      
    if (fX > 0.206893)
        X = pow3(fX);
    else
        X = (fX - 16.0/116.0) / 7.787;

    fZ = fY - b /200.0;      
    if (fZ > 0.206893)
        Z = pow3(fZ);
    else
        Z = (fZ - 16.0/116.0) / 7.787;

    X *= (0.950456 * 255);
    Y *=             255;
    Z *= (1.088754 * 255);
    return [X, Y, Z]
}

function XYZ2LAB(clr)
{
	var x = clr[0], y = clr[1], z = clr[2];
    var ref_X =  95.047 * 2.55;
    var ref_Y = 100.000 * 2.55;
    var ref_Z = 108.883 * 2.55;

    var var_X = x / ref_X  ;          //ref_X =  95.047   Observer= 2°, Illuminant= D65
    var var_Y = y / ref_Y ;          //ref_Y = 100.000
    var var_Z = z / ref_Z ;          //ref_Z = 108.883

    if ( var_X > 0.008856 ) var_X = Math.pow(var_X, 1/3.0 )
    else                    var_X = ( 7.787 * var_X ) + ( 16 / 116 )
    if ( var_Y > 0.008856 ) var_Y = Math.pow(var_Y , 1/3.0 )
    else                    var_Y = ( 7.787 * var_Y ) + ( 16 / 116 )
    if ( var_Z > 0.008856 ) var_Z = Math.pow(var_Z, 1/3.0 )
    else                    var_Z = ( 7.787 * var_Z ) + ( 16 / 116 )

    CIE_L = ( 116 * var_Y ) - 16
    CIE_a = 500 * ( var_X - var_Y )
    CIE_b = 200 * ( var_Y - var_Z )

	return [CIE_L, CIE_a, CIE_b]
}


function RGB2XYZ(clr)
{
	var var_R = clr[0], var_G = clr[1], var_B = clr[2]
    //Observer. = 2°, Illuminant = D65
    // SRGB
    X = var_R * 0.4124 + var_G * 0.3576 + var_B * 0.1805
    Y = var_R * 0.2126 + var_G * 0.7152 + var_B * 0.0722
    Z = var_R * 0.0193 + var_G * 0.1192 + var_B * 0.9505
    return [X, Y, Z]
}


function XYZ2RGB(clr)
{
	var X = clr[0], Y = clr[1], Z = clr[2];
	var RR =  (3.240479*X - 1.537150*Y - 0.498535*Z + 0.5);
    var GG = (-0.969256*X + 1.875992*Y + 0.041556*Z + 0.5);
    var BB = (0.055648*X - 0.204043*Y + 1.057311*Z + 0.5);

    R = Math.round(RR < 0 ? 0 : RR > 255 ? 255 : RR);
    G = Math.round(GG < 0 ? 0 : GG > 255 ? 255 : GG);
    B = Math.round(BB < 0 ? 0 : BB > 255 ? 255 : BB);

    return [R, G, B]
}


var imageData = null;
var abCorrection = 2.0;
var LCorrection = 30.0;


function updateCanvas(L, av, bv, mv) {
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext("2d");

	 
	for(var a = 0; a < 512; a++) {
		for(var b = 0; b < 512; b++) {
			var arr = [];
			arr = XYZ2RGB(LAB2XYZ([L + LCorrection, 
						(a / 2 - 127 + av / abCorrection) * mv , 
						(b / 2 - 127  + bv / abCorrection) * mv], 0, 0))

			//arr = [a, b, 0]
			if(imageData) {
				var ind = (512*b + a);
				arr = [imageData[4*ind], imageData[4*ind + 1], imageData[4*ind+2]];

				arr = XYZ2LAB(RGB2XYZ(arr))
				arr = XYZ2RGB(LAB2XYZ([arr[0] * L / 50,
					 arr[1] * mv + av/abCorrection, 
					 arr[2] * mv + bv/abCorrection]))
			}

			ctx.fillStyle = 'rgb('+arr[0]+','+arr[1]+','+arr[2]+')'
			ctx.fillRect(a,b, 1, 1);
		}
	}	


	ctx.strokeStyle="white";

	ctx.beginPath();
	ctx.moveTo(0,256);
	ctx.lineTo(512,256);
	ctx.moveTo(256,0);
	ctx.lineTo(256,512);
	ctx.stroke();
}
function refresh() {
	var vl = Math.pow($('#sat_correction').val() / 50.0, 3);
	updateCanvas($('#range_luminance').val() * 1.0,
		$('#a_correction').val()*1.0 - 50, 
		$('#b_correction').val()*1.0 - 50,
		vl);	
	$('#text_luminance').text($('#range_luminance').val())
	$('#txt_a_correction').text(($('#a_correction').val() - 50) / abCorrection);
	$('#txt_b_correction').text(($('#b_correction').val() - 50) / abCorrection);
	$('#txt_sat_correction').text( Math.round(vl * 100) / 100.0)

}


$(document).ready(function(){
	refresh()
	$('#lab_btn').on('click', function() {
		imageData = null;
		refresh();
	});
	$('.test_btn').each(function() {
		let obj = $( this );
		obj.on('click', function() {
			var canvas = document.getElementById("myCanvas");
			var ctx = canvas.getContext("2d");
    		drawing = new Image();
			drawing.crossOrigin="anonymous";
			drawing.src = "images/"+obj.attr("img-data"); // can also be a remote URL e.g. http://
			drawing.onload = function() {
   				ctx.drawImage(drawing, 512, 0, 512, 512);
   				imageData = ctx.getImageData(512, 0, 512, 512).data;
   				refresh();
			}
		});
	});

	
	$('#range_luminance').change(refresh)
	$('#a_correction').change(refresh)
	$('#b_correction').change(refresh)
	$('#sat_correction').change(refresh)
})


</script>

</body>
</html>

